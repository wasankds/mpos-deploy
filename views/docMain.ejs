<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/meta',{ time:time}) %>
  <title><%= title %></title>
  <!-- Font Awesome -->
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="/cdn/fontawesome/css/all.min.css">
  <!-- SweetAlert2 -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
  <script src="/cdn/sweetalert2.all.min.js"></script>
  <!-- Flatpkr -->
  <link rel="stylesheet" href="/cdn/flatpickr.min.css">
  <script src="/cdn/flatpickr.js"></script>

  <% if(!IS_PRODUCTION) { %>
  <!-- <link rel="stylesheet" href="/css/cb.css"> -->
  <link rel="stylesheet" href="/css/utils.css">
  <link rel="stylesheet" href="/css/fonts.css">
  <link rel="stylesheet" href="/css/alink.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="stylesheet" href="/css/flex.css">
  <link rel="stylesheet" href="/css/flexNew.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="/css/nav.css">
  <link rel="stylesheet" href="/css/modal.css">
  <link rel="stylesheet" href="/css/inputDoc.css">
  <link rel="stylesheet" href="/css/doc_tableRowImage.css">
  <link rel="stylesheet" href="/css/same.css">
  <link rel="stylesheet" href="/css/docMain.css">
  <% }else{ %>
  <link rel="stylesheet" href="/css-min/docMain.min.css?v=<%= time %>">
  <% } %>
</head>

  <!-- header -->
  <%- include('partials/nav.ejs') %>
  <%- include('partials/notify.ejs', {msg:msg}) %>   


<body>

  <header class="title-header <%= CLASS_BG_COLOR %>">
    <p class="al-c fc-white">
      <i class="<%= FA %>"></i>
      <span><%= LIST_TITLE %></span>
    </p>
  </header>

  <!-- Toolbar -->
  <header class="header-ctn">
    <section class="header-toolbar ">

      <!--  -->
      <form class="header-toolbar-1 flex-row w-100 dp-n ">
        
        <button class="col-sm-2 btn btn-sm bg-load nowrap" id="btnLoadLastDoc" title="โหลดเอกสารล่าสุด">
          <i class="fa fa-download mg-r-s"></i>ล่าสุด
        </button>        

        <input class="col-sm-7 al-c bdr3 no-x" type="search" autocomplete="off" 
               title="เลขที่/ปี-เดือน-วัน"
               required pattern=".{2,}"
               placeholder="เลขที่/ปี-เดือน-วัน" id="sip" name="sip"> 

        <button class="col-sm-1 btn btn-sm bg-search" id="btnSearchDocs" title="ค้นหาเอกสาร">
          <i class="fa fa-search"></i>
        </button>
      </form>
      
      <!-- เริ่มต้นยังไม่แสดง -->
      <form class="header-toolbar-2 w-100 dp-n">
        <div class="flex-row">
          <button class="col-sm-1 btn btn-sm bg-clear" title="ล้างผลการค้นหา" 
                  id="btnClearSearch" ><i class="fa fa-broom"></i></button>
          <select class="col-sm-7 al-l bdr3 w-100" 
                  id="selectDocToLoad" name="selectDocToLoad"></select>
          <input class="col-sm-1 al-c  bdr3" type="text" 
                  id="searchResNum" readonly>
          <button class="col-sm-1 btn btn-sm bg-load" type="submit" 
                  id="btnLoadDoc" title="โหลดเอกสาร">
            <i class="fa fa-download"></i>
          </button> 
        </div>
      </form>

      <!--  -->
      <!-- data-show-price : กรณีต้องการแสดงราคาในดหมดปุ่มใส่ 1 -->
      <%
        let showPrice = ['sales','return'].includes(DOC_TYPE) ? 1 : 0 ; 
      %>
      <div class="header-toolbar-3">
        <button class="btn btn-sm bg-switch" 
                data-show-price="<%= showPrice %>"
                id="btnModeButton">
          <i class="fa fa-hand-pointer pd-r-m"></i>โหมดปุ่ม
        </button>
        <button class="btn btn-sm bg-load mg-l-s" title="แสดงแถบเครื่องค้นหา"
                id="btnShowSearch">
            <!-- <i class="fa fa-toolbox mg-r-s"></i>เครื่องมือโหลด -->
            <i class="fa fa-download mg-r-s"></i>โหลด
        </button>
      </div>
      
      <!--  -->
      <div class="header-toolbar-4">
        <button class="btn btn-sm bg-new"  title="สร้างเอกสารใหม่"
                id="btnNewDoc">
          <i class="fa fa-file-circle-plus mg-r-s"></i>ใหม่
        </button>
      </div>

      <!--  -->
      <div class="header-toolbar-5">
        <div class="d-flex align-items-center">

          <% if(hoursCanEdit > 0){ %>
          <button class="btn btn-sm bg-finish" title="จบเอกสาร"
                  id="btnFinishDoc" >
            <i class="fa fa fa-flag-checkered mg-r-s"></i>จบ
          </button>
          <% } %>
          
          <button class="btn btn-sm bg-cancel mg-l-s" title="ยกเลิกเอกสาร"
                  id="btnCancelDoc" >
            <i class="fa fa fa-times-circle mg-r-s"></i>ยกเลิก
          </button>
        </div>
      </div>

    </section>
  </header> 


  <!-- MAIN CONTAINER -->
  <main>

    <!-- FORM -->
    <form id="mainForm" action="<%= PATH_MAIN %>" method="post" autocomplete="off">

      <!--  ฝั่ง - ไปตรวจสอบบน Server  -->
      <input type="hidden" id="docType" value="<%= DOC_TYPE %>">

      <!-- #1 : Title -->
      <section>

        <!-- #1.1 -->
        <div class="flex-main">
          <div class="flex-5 flex-row">

            <!--  -->
            <div class="col-sm-f flex-row">
              <input class="col-sm-4-5 al-c bdr3-left" type="text" 
                     placeholder="เลขที่เอกสาร" title="เลขที่เอกสาร"
                     readonly data-alway-readonly="1"
                     style="border-right: none;"
                     id="docId" name="docId">
              <input class="col-sm-3-5 al-c" type="text" 
                     placeholder="วันที่และเวลา" title="วันที่และเวลา"
                     readonly data-alway-readonly="1"
                     style="border-right: none;"
                     name="docDateTime" id="docDateTime">
              <input class="col-sm-2 al-c bdr3-right" type="text" 
                     placeholder="สถานะ" title="<%= DOC_STATUS_TITLE %>"
                     readonly data-alway-readonly="1"
                     name="docStatusNumber" id="docStatusNumber">
            </div>

            <!--  -->
            <!-- <div class="col-sm-5 flex-row">
              <input class="col-sm-3 al-c bdr3-left no-arrow" type="number" 
                     placeholder="ไอดีสาขา" title="ไอดีสาขา"
                     readonly data-alway-readonly="1"
                     style="border-right: none;"
                     id="branchId" name="branchId" value="<%= user.branchId %>">
              <input class="col-sm-7 al-c bdr3-right" type="text" 
                     placeholder="ชื่อสาขา" title="ชื่อสาขา"
                     readonly data-alway-readonly="1"
                     id="branchName" name="branchName" value="<%= user.branchName %>">
            </div> -->

          </div>

          <!--  -->
          <div class="flex-5 flex-row">
            <div class="col-sm-3-5 flex-row">
              <input class="col-sm-3 al-c bdr3-left no-arrow" type="number" 
                     placeholder="ไอดีสาขา" title="ไอดีสาขา"
                     readonly data-alway-readonly="1"
                     style="border-right: none;"
                     id="branchId" name="branchId" value="<%= user.branchId %>">
              <input class="col-sm-7 al-c bdr3-right" type="text" 
                     placeholder="ชื่อสาขา" title="ชื่อสาขา"
                     readonly data-alway-readonly="1"
                     id="branchName" name="branchName" value="<%= user.branchName %>">
            </div>

            <div class="col-sm-6-5 flex-row">
              <input class="col-sm-2 al-c bdr3-left no-arrow" type="number" 
                     placeholder="ไอดียูสเซอร์" title="ไอดียูสเซอร์"
                     readonly  data-alway-readonly="1"
                     style="border-right: none;"
                     id="userId" name="userId" value="<%= user.userId %>">
              <input class="col-sm-8 al-c bdr3-right" type="text" 
                     placeholder="ชื่อสกุลผู้ใช้" title="ชื่อสกุลผู้ใช้"
                     readonly data-alway-readonly="1"
                     id="userFullname" name="userFullname" value="<%= user.userFullname %>">
            </div>
          </div>
        </div><!-- #1.2 -->

        <!-- #1.3 -->
        <% if(['warehouseIn'].includes(DOC_TYPE)){ %>
        <div class="flex-main mg-t-s">

          <div class="flex-4 flex-row">
            <div class="col-sm-f modalCtn lh-3xs">
              <input class="al-c bg-ligreen bdr3 pd-t-s pd-b-s " type="text" 
                     id="searchSuppliers"  placeholder="ค้นหาผู้จัดจำหน่าย"
                     onfocus="popModalSuppliers(event)" 
                     oninput="popModalSuppliers(event)" >
              <div class="modal"><div class="modal-list"></div></div>
            </div>
          </div> 

          <div class="flex-6 flex-row">
            <input class="col-sm-3 al-c bdr3-left " 
                    type="text" title="ไอดีผู้จัดจำหน่าย" placeholder="ไอดี"
                    style="border-right: none;"
                    required readonly  data-alway-readonly="1"
                    name="supplierId" id="supplierId" >
            <input class="col-sm-7 al-l pd-l-s bdr3-right " 
                    type="text" title="ชื่อผู้จัดจำหน่าย" placeholder="ชื่อผู้จัดจำหน่าย"
                    required readonly data-alway-readonly="1"
                    name="supplierName" id="supplierName" >
          </div> 

        </div>
        <!-- #1.3 -->
        <% } %>

        <!-- #1.4 -->
        <div class="flex-row">

          <!-- เอกสารอ้างอิงมีเฉพาะใน Warehouse/return -->
          <% if(['warehouseIn', 'warehouseOut', 'return'].includes(DOC_TYPE)){ %>
          <!--  -->
          <div class="col-sm-4 flex-row">
            <div class="col-sm-f input-group">
              <%
                const isRequiredRef = (DOC_TYPE == 'return') ? 'required' : '' ;
                const titleRef = (DOC_TYPE == 'return') ? 'ต้องมีเลขที่เอกสารอ้างอิง' : '' ;
              %>
              <label class="pd-r-s" title="<%= titleRef %>">
                <span>เอกสารอ้างอิง</span>
                <% if(isRequiredRef){ %><span class="fc-red">*</span><% } %>
              </label>              
              <input class="al-c bdr3" type="text" title="เอกสารอ้างอิง"
                      name="refId" id="refId"
                      <%= isRequiredRef %>
                      placeholder="เอกสารอ้างอิง">
            </div>
          </div>

          <!--  -->
          <div class="col-sm-6 flex-row">

            <div class="col-sm-w100 input-group">
              <label class="pd-r-s">
                <i class="fas fa-image"></i>
                <span>อัปโหลดภาพเอกสารอ้างอิง</span>
              </label>
              <!-- ไม่ต้องระบุ name เพราะจะไปจับจาก id แยกต่างหาก -->
              <input class="al-l ba-8 bdr3 pd-l-s" type="file" 
                     style="padding-top: 2px;"
                     title="ไฟล์ภาพ .jpgไม่เกิน 10MB"
                     accept="image/jpeg"
                     id="refImage">
            </div>
  
            <div class="input-group">
              <label class="pd-r-s">&nbsp;</label>
              <button class="btn btn-sm bg-333" type="button"
                      disabled
                      id="btnViewImage" title="ดูภาพเอกสารแนบ">
                <i class="fa fa-eye"></i>
              </button>
            </div>

          </div>
          <% } %>

        </div> <!-- #1.4 -->

      </section> 

      <!--#2 : ค้นหา/เพิ่มไอเท็ม -->
      <div class="flex-row mg-t-m">
        <div class="col-sm-f modalCtn h-100">
          <input class="al-c bg-ligreen bdr3 pd-t-s pd-b-s" type="text" 
                 id="searchItems"  placeholder="ค้นหาไอเท็ม"
                 onfocus="popModalItems(event)" 
                 oninput="popModalItems(event)" >
          <div class="modal"><div class="modal-list"></div></div>
        </div>
      </div>

      <!-- #3 : กรณีโหมดปุ่ม  -->
      <section>
        <!-- เก็บปุ่ม Category/Pagination/Items -->
        <div class="dp-n categoryButtonsCtn" id="categoryButtonsCtn"></div>
        <div class="dp-n paginationCtn" id="paginationCtn"></div>
        <div class="dp-n itemsButtonsCtn" id="itemsButtonsCtn"></div>
      </section> 

      <!-- #4 -->
      <div id="tableRowCtn">


        <!--  -->
        <div id="listCtn"></div>

        <!--  -->
        <% if(['warehouseIn', 'sales', 'return'].includes(DOC_TYPE)){ %>
        <section class="flex-row mg-t-m" id="mainTotalCtn">

          <!-- ชำระเงิน1 -->
          <% if(['sales','return'].includes(DOC_TYPE)){ %>
          <div class="col-sm-3 payment-ctn " id="paymentMethod1Ctn">
            <div class="input-group">
              <label>ชำระเงิน1</label>
              <input class="w-100 al-r pd-r-s bdr3 no-arrow" type="number" placeholder="จำนวนเงิน1"
                      name="paymentAmount1" id="paymentAmount1" required>
            </div>
            <% global.PAY_TYPE1.forEach( obj => { %>
              <% if(obj.page.includes(DOC_TYPE)){ %>
              <div>
                <input type="radio" name="paymentMethod1" id="<%= obj.id %>"   
                      value="<%= obj.paytype %>" required>
                <label for="<%= obj.id %>" class="<%= obj.color %>"><%= obj.payTypeThai %></label>
              </div>            
              <% } %>
            <% }) %>
          </div>

          <!-- ชำระเงิน2 -->
          <div class="col-sm-4 payment-ctn pd-l-m" id="paymentMethod2Ctn">
            <div class="input-group">
              <label class="">ชำระเงิน2</label>
              <input class="w-100 al-r pd-r-s bdr3  no-arrow" type="number" placeholder="จำนวนเงิน2"
                     name="paymentAmount2" id="paymentAmount2" required>
            </div>
            <% global.PAY_TYPE2.forEach( obj => { %>
              <% if(obj.page.includes(DOC_TYPE)){ %>
              <div>
                <input type="radio" name="paymentMethod2" id="<%= obj.id %>"   
                      value="<%= obj.paytype %>" required>
                <label for="<%= obj.id %>" class="<%= obj.color %>"><%= obj.payTypeThai %></label>
              </div>
              <% } %>
            <% }) %>  
          </div>

          <% }else{ %>
          <!-- ถ้าไม่มีข้างบนใช้ตัวนี้ -->
          <div class="col-sm-7"></div>  
          <% } %>

          <!-- รวม -->          
          <div class="col-sm-3 flex-row">
            <label class="mg-r-s">&nbsp;</label>
            <input class="bdr3 al-r pd-r-s" type="text" placeholder="รวมเงิน"
                    style="max-height:1.65rem;width: 100%;" 
                    readonly required
                    data-alway-readonly="1"
                    id="totalAmount" name="totalAmount">
          </div>
        </section>
        <% } %>
      </div>

      <!-- #5 หมายเหตุ -->
      <div class="flex-row mg-t-s">
        <label class="pd-r-s">หมายเหตุ</label>
        <input class="col-sm-w100 al-l pd-l-s bdr3" type="text" title="หมายเหตุ" placeholder="หมายเหตุ"
               name="docRemark" id="docRemark">
      </div>

      <!-- #6 ปุ่มท้ายหน้า -->
      <div class="al-c bt mg-t-l pd-t-m">
        <div class="d-flex justify-content-between">

          <!--  -->
          <%
            const saveTitle = `ระยะเวลาแก้ไข ${hoursCanEdit} ชม.\nระยะเวลายกเลิก ${hoursCanCancel} ชม.`
          %>
          <button class="btn btn-sm bg-save" id="btnSave" title="<%= saveTitle %>">
            <i class="fa fa fa-save mg-r-s"></i>บันทึก
          </button>

          <!-- <div> รวมกลุ่มปุ่มไว้ใกล้กัน -->
          <button class="btn btn-sm bg-print" id="btnPrint" title="พิมพ์">
            <i class="fa  fa-solid fa-print mg-r-s"></i>พิมพ์
          </button>

          <% if(settings.DOWNLOAD_DOC_AS_IMAGE == 'on'){ %>
          <button class="btn btn-sm btn-sm bg-download" id="btnDownloadImage" title="ดาวน์โหลดภาพ">
            <i class="fa fa fa-download mg-r-s"></i>ภาพ
          </button> 
          <% } %>
          <!-- </div> -->
          
          <% if(hoursCanEdit > 0){ %>
          <button class="btn btn-sm bg-change " id="btnPrintChanges" title="ดูประวัติการเปลี่ยนแปลง">
            <i class="fa fa-solid fa-print mg-r-s"></i>ประวัติ
          </button>
          <% } %>

        </div>
      </div>
        
    </form>    


    <!-- ยืนยันชำระหนี้แล้ว มีกรณีที่มีการค้างชำระ -->
    <% if(['sales'].includes(DOC_TYPE)){ %>    
    <section id="payDebtCtn"></section> <!-- ต้องทำให้ว่างเพื่อ empty จะทำงานได้ -->
    <% } %>

    <!-- แจ้งเวลา -->
    <section class="dp-n" id="docRemain" >
      <div id="docRemainEdit"></div>
      <div id="docRemainCancel"></div>
    </section>

  </main>


  <%- include('partials/footer.ejs') %>
  
  <script>    
    const PREFIX = `<%= PREFIX %>` ;
    const PATH_MAIN =  `<%= PATH_MAIN %>` ; 
    const PATH_FETCH =  `<%= PATH_FETCH %>` ; 
    const PATH_SEARCH =  `<%= PATH_SEARCH %>` ; 
    const PATH_SAVE =  `<%= PATH_SAVE %>` ; 
    const PATH_LOAD =  `<%= PATH_LOAD %>` ; 
    const PATH_LOAD_LAST =  `<%= PATH_LOAD_LAST %>` ; 
    const PATH_PRINT =  `<%= PATH_PRINT %>` ; 
    const PATH_CHANGES =  `<%= PATH_CHANGES %>` ; 
    const PATH_STATUS =  `<%= PATH_STATUS %>` ; 
    const PATH_VIEW_IMAGE =  `<%= PATH_VIEW_IMAGE %>` ;
    const PATH_FETCH_IMAGE =  `<%= PATH_FETCH_IMAGE %>` ; 
    const PATH_PAY_DEBT =  `<%= PATH_PAY_DEBT %>` ;
    // สำหรับโหลดหรือค้นหาเลย
    const DOC_TYPE =  `<%= DOC_TYPE %>` ;
    const DOC_ID =  `<%= DOC_ID %>`;
    const SIP = `<%= SIP %>` ;
    const PAY_TYPE =  JSON.parse(`<%- PAY_TYPE_JSON %>`) ; // กรณีไม่มีจะเป็นสตริงว่าง
    const PAY_TYPE1 = JSON.parse(`<%- PAY_TYPE1_JSON %>`) ; // กรณีไม่มีจะเป็นสตริงว่าง
    const PAY_TYPE2 = JSON.parse(`<%- PAY_TYPE2_JSON %>`) ; // กรณีไม่มีจะเป็นสตริงว่าง
  </script>

  <% if(!IS_PRODUCTION) { %>
  <script type="text/javascript" src="/js/script_all.js"></script>
  <script type="text/javascript" src="/js/nav.js"></script>
  <script type="text/javascript" src="/js/notify.js"></script>
  <script type="text/javascript" src="/js/doc_print.js?v=<%= time %>"></script>
  <script type="text/javascript" src="/js/doc_tools.js?v=<%= time %>"></script>  
  <script type="text/javascript" src="/js/doc_formAction.js?v=<%= time %>"></script>  
  <script type="text/javascript" src="/js/doc_crud.js?v=<%= time %>"></script>  
  <script type="text/javascript" src="/js/doc_modal.js?v=<%= time %>"></script>
  <script type="text/javascript" src="/js/doc_tableRows.js?v=<%= time %>"></script>
  <script type="text/javascript" src="/js/docMain.js?v=<%= time %>"></script>
  <% }else{ %>
  <script type="text/javascript" src="/js-min/docMain.obf.js?v=<%= time %>"></script>
  <% } %>

</body>
</html>



<!-- เทมเพลตฟอร์มชำระเงิน -->
<% if(['sales'].includes(DOC_TYPE)){ %>

<!--  -->
<template id="templatePayDebtToolbar">
  <div class="pay-debt-toolbar d-flex justify-content-between pd-l-m">
    <!-- Add -->
    <div>
      <label class="fs-sm fc-white pd-r-s">ชำระหนี้</label>
      <button class="btn btn-sm bg-save btn-add-pay-debt-row"
              onclick="addPayDebtRow(event)"><i class="fas fa-plus pd-l-s pd-r-s"></i>
      </button>
    </div>
    <!-- Undo -->
    <button class="btn btn-sm bg-undo btn-undo-pay-debt-row"
            onclick="undoPayDebtRow(event)"><i class="fas fa-rotate-left pd-l-s pd-r-s"></i>
    </button>
    <!-- Save -->
    <button class="btn btn-sm bg-save btn-save-pay-debt" title="บันทึกการชำระหนี้"
        onclick="savePayDebt(event)"><i class="fas fa-save mg-r-s"></i>บันทึกการชำระหนี้
    </button>
  </div>  
</template>

<!--  -->
<template id="templatePayDebtRow">
  <div class="pay-debt-row flex-main">
    <!--  -->
    <div class="flex-4 flex-row">
      <input class="col-sm-4 al-r pd-r-m bdr3-left no-arrow" 
             required
             type="number" name="payDebt_amount"
             placeholder="จำนวนเงินที่ชำระหนี้" title="จำนวนเงินที่ชำระหนี้">
      <input class="col-sm-6 al-c bdr3-right no-arrow"
             style="border-left: none;"
             required readonly
             type="text" name="payDebt_dateTime"
             placeholder="วันที่ชำระหนี้" title="วันที่ชำระหนี้">
    </div>
    <!--  -->
    <div class="flex-6 flex-row">
      <input class="col-sm-2 al-c bdr3-left no-arrow" 
             required readonly 
             type="number" name="payDebt_userId"
             placeholder="ไอดี" title="ไอดี">
  
      <input class="col-sm-7 al-l pd-l-m bdr3-right" 
             style="border-left: none;"
             required readonly 
             type="text" name="payDebt_userFullname"
             placeholder="ผู้รับชำระหนี้" title="ผู้รับชำระหนี้">

      <button class="col-sm-1 btn btn-sm bg-delete btn-remove-debt-row"
              onclick="removePayDebtRow(event)"><i class="fas fa-trash"></i>
      </button>
    </div>
  </div>
</template>
<% } %>





<!--  -->
<!-- <div class="lh-2xs">
  <span class="fc-white fs-sm">ผู้รับชำระหนี้ : </span>
  <span class="fc-liblue fs-sm">[</span>
  <span class="fc-liblue fs-sm payDebt_userId"></span>
  <span class="fc-liblue fs-sm">]</span>
  <span class="fc-white fs-sm payDebt_userFullname"></span>
</div> -->

<!--  -->
  <!-- <div class="lh-2xs">
  <span class="fc-white fs-sm">วันที่ชำระหนี้ : </span>
  <span class="fc-liblue fs-sm payDebt_dateTime"></span>
</div> -->


<!-- 
<label class="cb-ctn mg-r-xl fc-white">ชำระหนี้แล้ว
  <input type="checkbox" id="payDebt" name="payDebt">
  <span class="cb-checkmark"></span>
</label> 
-->